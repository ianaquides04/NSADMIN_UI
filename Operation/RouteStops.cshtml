@model List<NextStop_AdminMVC.Models.DataModels.BusRoutes>

<style>
    body {
        background-color: #f8f9fa;
    }

    .modal-header {
        background-color: #2f3b3e;
        color: #fff;
    }

    .upload-box {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 40px;
        text-align: center;
        color: #888;
        cursor: pointer;
    }

        .upload-box i {
            font-size: 28px;
            display: block;
            margin-bottom: 8px;
            color: #999;
        }

    .btn-save {
        background-color: #1cb5bd !important;
        border: none !important;
        color: #fff !important;
        font-weight: 500;
        border-radius: 4px;
    }

        .btn-save:hover {
            background-color: #15989f !important;
            color: #fff !important;
        }

    .btn-outline-save {
        color: #1cb5bd !important;
        border: 1px solid #1cb5bd !important;
        background-color: #fff !important;
        font-weight: 500;
        border-radius: 4px;
    }

        .btn-outline-save:hover {
            background-color: #e6f7f8 !important;
            color: #1cb5bd !important;
        }

    .radio-inline {
        display: inline-flex;
        align-items: center;
        gap: 15px;
        margin-left: 15px;
    }

    .radio-label {
        margin-left: 5px;
    }
    /* Dimmed overlay for modal background */
    .modal-dimmed {
        opacity: 0.4;
        pointer-events: none;
    }

    .btn-delete {
        background-color: #ff4141 !important;
        border: none !important;
        color: #fff !important;
        font-weight: 500;
        border-radius: 4px;
    }

        .btn-delete:hover {
            background-color: #e63936 !important;
            color: #fff !important;
        }

    .btn-outline-delete {
        color: #1cb5bd !important;
        border: 1px solid #1cb5bd !important;
        background-color: #fff !important;
        font-weight: 500;
        border-radius: 4px;
    }

        .btn-outline-delete:hover {
            background-color: #e6f7f8 !important;
            color: #1cb5bd !important;
        }
</style>
<div class="head-title">
    <div class="left">
        <h1>Operations</h1>
        <ul class="breadcrumb">
            <li><a href="#">Operations</a></li>
            <li><i class='bx bx-chevron-right'></i></li>
            <li><a class="active2" asp-controller="Operation" asp-action="Operations">Home</a></li>
            <li><i class='bx bx-chevron-right'></i></li>
            <li><a class="active1" href="#">Routes & Stops</a></li>
        </ul>
    </div>
</div>

<div style="margin: 20px;">
    <div class="datalbl">
        <asp:Label> <h5>Bus Routes</h5></asp:Label>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createRouteModal">
            <i class='bx bx-add-to-queue'></i>
            <span>Create route</span>
        </button>
    </div>

    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>
                        <button class="sortbtn">
                            <a class="sortlbl" asp-action="RouteStops" asp-route-sortOrder="@ViewData["IndexSort"]"> 
                                # <i class='bx bxs-sort-alt'></i>
                            </a>
                        </button>   
                    </th>
                    <th>
                        <button class="sortbtn">
                            <a class="sortlbl" asp-action="RouteStops" asp-route-sortOrder="@ViewData["NameSort"]">
                                Name <i class='bx bxs-sort-alt'></i>
                            </a>
                        </button>
                    </th>
                    <th>
                        <button class="sortbtn">
                            <a class="sortlbl" asp-action="RouteStops" asp-route-sortOrder="@ViewData["CodeSort"]">
                                Code <i class='bx bxs-sort-alt'></i>
                            </a>
                        </button>
                    </th>
                    <th>Status</th>
                    <th>Visual Map</th>
                    <th>Stops</th>
                    <th>Actions</th>
                </tr>
            </thead>

            @if (Model != null && Model.Count > 0)
            {
                <tbody>
                    @for (int i = 0; i < Model.Count; i++)
                    {
                        <tr>
                            <td>@(i+1)</td>
                            <td>@Model[i].routeName</td>
                            <td>@Model[i].routeCode</td>
                            <td>@Model[i].Status</td>
                            <td>
                                <a href="@Model[i].VisualMap" target="_blank" style="text-decoration: underline;">View image</a>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm">
                                    <a class="managelbl" asp-controller="Operation" asp-action="RouteStops_ManageStops" asp-route-routeName="@Model[i].routeName">
                                        Manage
                                    </a>
                                </button>
                            </td>
                            <td>
                                <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#updateRouteModal-@Model[i].Id">
                                    <i class='bx bxs-edit'></i>
                                </button>

                                <button class="btn btn-danger btn-sm"><i class='bx bxs-x-square' data-bs-toggle="modal" data-bs-target="#deleteConfirmModal"></i></button>
                            </td>
                        </tr>

                        <!-- Update Route Modal -->
                        <div class="modal fade" id="updateRouteModal-@Model[i].Id" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                            <div class="modal-dialog modal-lg modal-dialog-centered">
                                <div class="modal-content">
                                    <form id="updateRouteForm-@Model[i].Id" asp-action="Update" method="post" enctype="multipart/form-data">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Update Route</h5>
                                        </div>
                                        <div class="modal-body">

                                            <input type="hidden" name="Id" value="@Model[i].Id" />
                                            <input type="hidden" name="ExistingVisualMap" value="@Model[i].VisualMap" />

                                            <!-- Name -->
                                            <div class="mb-3">
                                                <label class="form-label">Name</label>
                                                <input type="text" name="Name" class="form-control" value="@Model[i].routeName" />
                                            </div>

                                            <!-- Code + Status -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Code</label>
                                                    <input type="text" name="Code" class="form-control" value="@Model[i].routeCode" />
                                                </div>
                                                <div class="col-md-6 d-flex align-items-end">
                                                    <div>
                                                        <label class="form-label d-block">Status</label>
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" name="Status"
                                                                   @if (Model[i].Status == "Active")
                                                                    {
                                                                        @:checked="checked"
                                                                    }/>

                                                            @* <input asp-for="@Model[i].Status" class="form-check-input" /> *@
                                                            <label class="form-check-label">Active</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Visual Map -->
                                            <div class="mb-4">
                                                <label class="form-label">Visual Map</label>
                                                <label class="upload-box w-100">
                                                    <i class="bi bi-upload"></i>
                                                    <span>Upload a new file (optional)</span>
                                                </label>
                                                <input type="file" name="VisualMap" class="d-none">
                                                <small>Current: <a href="@Model[i].VisualMap" target="_blank">View</a></small>
                                            </div>

                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-save text-white px-4"
                                                    data-bs-toggle="modal" data-bs-target="#confirmUpdateModal-@Model[i].Id">
                                                Save
                                            </button>
                                            <button type="button" class="btn btn-outline-save px-4" data-bs-dismiss="modal">Cancel</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Confirm Update Modal -->
                        <div class="modal fade" id="confirmUpdateModal-@Model[i].Id" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                            <div class="modal-dialog modal-dialog-centered" style="max-width:500px;">
                                <div class="modal-content p-4 text-start">
                                    <h5 class="mb-4">Update this route?</h5>
                                    <div class="d-flex justify-content-end gap-3">
                                        <button type="submit" form="updateRouteForm-@Model[i].Id" class="btn btn-save text-white px-4">Update</button>
                                        <button type="button" class="btn btn-outline-save px-4" data-bs-dismiss="modal">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                 }
                </tbody>
            }
            else
            {
                <tbody>
                    <tr><td colspan="7" style="text-align: center;">No routes available.</td></tr>
                </tbody>
            }
        </table>
    </div>
</div>

<!-- Create Route Modal -->
<div class="modal fade" id="createRouteModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <!-- FIX: Disable background close -->
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Route</h5>
            </div>
            <div class="modal-body">
                <form id="createRouteForm" asp-action="Create" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="Name" class="form-label">Name</label>
                        <input type="text" id="Name" name="Name" class="form-control">
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="Code" class="form-label">Code</label>
                            <input type="text" id="Code" name="Code" class="form-control">
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <label class="form-label mb-0">Visual Map</label>
                            <div class="radio-inline">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="mapType" id="mapImage" value="image" checked>
                                    <label class="form-check-label radio-label" for="mapImage">Image</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="mapType" id="mapLink" value="link">
                                    <label class="form-check-label radio-label" for="mapLink">Link</label>
                                </div>
                            </div>
                        </div>

                        <div id="uploadBoxWrapper">
                            <label for="VisualMap" class="upload-box w-100">
                                <i class="bi bi-upload"></i>
                                <span>Upload a file</span>
                            </label>
                            <input type="text" id="VisualMap" name="VisualMap" class="d-none">
                        </div>

                        <div id="linkBoxWrapper" class="d-none">
                            <input type="text" id="VisualMapLink" name="VisualMapLink" class="form-control">
                        </div>
                    </div>

                    <div class="text-end d-flex justify-content-end gap-2">
                        <button type="button" id="btnOpenSaveConfirm" class="btn btn-save text-white px-4" data-bs-toggle="modal" data-bs-target="#saveConfirmModal">Save</button>
                        <button type="button" class="btn btn-outline-save px-4" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Save Confirmation Modal -->
<div class="modal fade" id="saveConfirmModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <!-- FIX: Disable background close -->
    <div class="modal-dialog modal-dialog-centered" style="max-width:500px;">
        <div class="modal-content p-4 text-start">
            <h5 class="mb-4">Save Route?</h5>
            <div class="d-flex justify-content-end gap-3">
                <button type="submit" form="createRouteForm" class="btn btn-save text-white px-4">Save</button>
                <button type="button" id="btnCancelSave" class="btn btn-outline-save px-4" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<form id="createRouteForm" asp-action="Delete" method="post" enctype="multipart/form-data">
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <!-- FIX: Disable background close -->
        <div class="modal-dialog modal-dialog-centered" style="max-width:500px;">
            <div class="modal-content p-4 text-start">
                <h5 class="mb-4">Delete Route?</h5>
                <div class="d-flex justify-content-end gap-3">
                    <button type="submit" form="createRouteForm" class="btn btn-delete text-white px-4">Delete</button>
                    <button type="button" id="btnCancelSave" class="btn btn-outline-delete px-4" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</form>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!--Create Route Script-->
    <script>
        // FIX: Ensure static backdrop for all modals
        var createRouteModalEl = document.getElementById('createRouteModal');
        var saveConfirmModalEl = document.getElementById('saveConfirmModal');
        var deleteConfirmModalEl = document.getElementById('deleteConfirmModal');

        var createRouteModal = new bootstrap.Modal(createRouteModalEl, { backdrop: 'static', keyboard: false });
        var saveConfirmModal = new bootstrap.Modal(saveConfirmModalEl, { backdrop: 'static', keyboard: false });
        var deleteConfirmModal = new bootstrap.Modal(deleteConfirmModalEl, { backdrop: 'static', keyboard: false });

        // FIX: Proper Save flow
        document.getElementById('btnOpenSaveConfirm').addEventListener('click', function () {
            createRouteModal.hide();
            saveConfirmModal.show();
        });

        // FIX: Proper Cancel flow (reopen main modal)
        document.getElementById('btnCancelSave').addEventListener('click', function () {
            saveConfirmModal.hide();
            createRouteModal.show();
        });

        // FIX: Radio toggle for map upload
        document.querySelectorAll("input[name='mapType']").forEach(radio => {
            radio.addEventListener("change", function () {
                if (this.value === "image") {
                    document.getElementById("uploadBoxWrapper").classList.remove("d-none");
                    document.getElementById("linkBoxWrapper").classList.add("d-none");
                } else {
                    document.getElementById("uploadBoxWrapper").classList.add("d-none");
                    document.getElementById("linkBoxWrapper").classList.remove("d-none");
                }
            });
        });
    </script>

    <!--Update Route Script-->
    <script>
        // FIX: Ensure static backdrop and proper logic for Update Route modals
        document.querySelectorAll('[id^="updateRouteModal-"]').forEach((modalEl) => {
            const id = modalEl.id.split('-')[1];

            const updateRouteModalEl = document.getElementById('updateRouteModal-' + id);
            const confirmUpdateModalEl = document.getElementById('confirmUpdateModal-' + id);

            if (!updateRouteModalEl || !confirmUpdateModalEl) return;

            // Initialize modals with static backdrop (prevents closing when clicking background)
            const updateRouteModal = new bootstrap.Modal(updateRouteModalEl, { backdrop: 'static', keyboard: false });
            const confirmUpdateModal = new bootstrap.Modal(confirmUpdateModalEl, { backdrop: 'static', keyboard: false });

            // Find Save and Cancel buttons inside Update Route modal
            const saveBtn = updateRouteModalEl.querySelector('[data-bs-target="#confirmUpdateModal-' + id + '"]');
            const cancelBtn = updateRouteModalEl.querySelector('[data-bs-dismiss="modal"]');

            // SaveConfirm buttons
            const confirmSaveBtn = confirmUpdateModalEl.querySelector('button[type="submit"]');
            const confirmCancelBtn = confirmUpdateModalEl.querySelector('[data-bs-dismiss="modal"]');

            // FIX: Save button flow (Update Modal -> Confirm Modal)
            if (saveBtn) {
                saveBtn.addEventListener('click', function () {
                    updateRouteModal.hide();
                    confirmUpdateModal.show();
                });
            }

            // FIX: Cancel button in Confirm Modal (Confirm Modal -> reopen Update Modal)
            if (confirmCancelBtn) {
                confirmCancelBtn.addEventListener('click', function () {
                    confirmUpdateModal.hide();
                    updateRouteModal.show();
                });
            }

            // Cancel button in main Update Modal simply closes it
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function () {
                    updateRouteModal.hide();
                });
            }
        });
    </script>